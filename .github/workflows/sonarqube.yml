name: CI/CD with SonarQube and Django

on:
  push:
    branches:
      - main

permissions:
  issues: write
  statuses: write  # Added for commit status updates
  contents: write  # Added for potential future interactions

jobs:
  build-and-analyze:
    runs-on: ubuntu-latest

    steps:
      # ... [keep all existing steps unchanged] ...

  notify:
    runs-on: ubuntu-latest
    needs: build-and-analyze
    if: success()  # Only run if previous job succeeded
    steps:
      - name: ðŸ“¢ Create Success Status
        uses: LouisBrunner/checks-action@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          name: Code Approval
          status: completed
          conclusion: success
          output: '{"title":"Code Approved","summary":"âœ… All quality checks passed!\n\nSonarQube analysis successful\nTest coverage requirements met"}'

      - name: ðŸ“¢ Notify via GitHub Issues
        run: |
          gh issue create --title "CI/CD Approval" --body "ðŸš€ Production code approved!\n\nâ€¢ Quality gate passed\nâ€¢ Security checks cleared\nâ€¢ Test coverage met" --repo $GITHUB_REPOSITORY
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸŽ‰ Show Approval Annotation
        run: |
          echo "::notice title=Code Approved::âœ… Production deployment ready! All checks passed successfully."
          echo "Approval Details:"
          echo "- SonarQube Quality Gate: Passed"
          echo "- Test Coverage: Met requirements"
          echo "- Security Analysis: No critical issues"
