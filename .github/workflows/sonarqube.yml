name: SonarQube Code Analysis

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  sonar:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install SonarScanner
        run: |
          mkdir -p $HOME/.sonar
          curl -L -o $HOME/.sonar/sonar-scanner.zip https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-5.0.1.3006-linux.zip
          unzip $HOME/.sonar/sonar-scanner.zip -d $HOME/.sonar/
          echo "$HOME/.sonar/sonar-scanner-5.0.1.3006/bin" >> $GITHUB_PATH
          echo "SONAR_SCANNER_HOME=$HOME/.sonar/sonar-scanner-5.0.1.3006" >> $GITHUB_ENV

      - name: Debug SonarScanner Installation
        run: |
          echo "PATH: $PATH"
          sonar-scanner -v

      - name: Run SonarScanner
        run: |
          sonar-scanner \
            -Dsonar.projectKey=my_project \
            -Dsonar.organization=my_org \
            -Dsonar.host.url=https://sonarcloud.io \
            -Dsonar.token=${{ secrets.SONAR_TOKEN }}

      - name: Check Quality Gate
        id: quality-gate
        run: |
          STATUS=$(curl -s -u "${{ secrets.SONAR_TOKEN }}:" "https://sonarcloud.io/api/qualitygates/project_status?projectKey=my_project" | jq -r '.projectStatus.status')
          echo "SonarQube Quality Gate: $STATUS"
          if [ "$STATUS" == "OK" ]; then
            echo "QUALITY_GATE=pass" >> $GITHUB_ENV
          else
            echo "QUALITY_GATE=fail" >> $GITHUB_ENV
            exit 1
          fi

      - name: Create GitHub Issue on Failure
        if: env.QUALITY_GATE == 'fail'
        run: |
          gh issue create --title "SonarQube Quality Gate Failed" --body "The latest code scan failed SonarQube quality gate. Please review the results." --repo ${{ github.repository }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Show Success Pop-up (on Pass)
        if: env.QUALITY_GATE == 'pass'
        run: |
          echo "ðŸŽ‰ Code passed SonarQube Quality Gate!"
