name: SonarQube Code Analysis
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  SONAR_PROJECT_KEY: ${{ github.repository_owner }}_${{ github.event.repository.name }}
  SONAR_PROJECT_NAME: ${{ github.repository }}
  WORKSPACE: ${{ github.workspace }}
  LANG: C.UTF-8
  LC_ALL: C.UTF-8
  PYTHONUTF8: 1
  NODE_VERSION: '18'
  SONAR_SCANNER_VERSION: "5.0.1.3006"
  MIN_COVERAGE_THRESHOLD: 80

jobs:
  analyze:
    name: SonarQube Analysis
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
      checks: write
      pull-requests: write
      issues: write

    steps:
      # [Previous steps remain unchanged until the notification section]

      # Enhanced Success Summary with centered layout
      - name: Create Success Summary
        if: steps.sonarqube.outputs.sonar_exit_code == '0' && steps.sonarqube.outputs.coverage_percent >= env.MIN_COVERAGE_THRESHOLD
        run: |
          echo "## <div align='center'>✅ Code Quality Approved</div>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "<div align='center'>" >> $GITHUB_STEP_SUMMARY
          echo "  <img src='https://img.shields.io/badge/Coverage-${{ steps.sonarqube.outputs.coverage_percent }}%25-brightgreen' alt='Coverage'>" >> $GITHUB_STEP_SUMMARY
          echo "  <img src='https://img.shields.io/badge/Threshold-${{ env.MIN_COVERAGE_THRESHOLD }}%25-blue' alt='Threshold'>" >> $GITHUB_STEP_SUMMARY
          echo "</div>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "<div align='center'>" >> $GITHUB_STEP_SUMMARY
          echo "  <a href='${{ secrets.SONAR_HOST_URL }}/dashboard?id=${{ env.SONAR_PROJECT_KEY }}'>" >> $GITHUB_STEP_SUMMARY
          echo "    <img src='https://img.shields.io/badge/View_Full_Report-SonarQube-blue?logo=sonarqube' alt='View Report'>" >> $GITHUB_STEP_SUMMARY
          echo "  </a>" >> $GITHUB_STEP_SUMMARY
          echo "</div>" >> $GITHUB_STEP_SUMMARY

      # Enhanced Failure Summary with centered layout
      - name: Create Failure Summary
        if: steps.sonarqube.outputs.sonar_exit_code != '0' || steps.sonarqube.outputs.coverage_percent < env.MIN_COVERAGE_THRESHOLD
        run: |
          echo "## <div align='center'>❌ Code Quality Issues Detected</div>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "<div align='center'>" >> $GITHUB_STEP_SUMMARY
          echo "  <img src='https://img.shields.io/badge/Coverage-${{ steps.sonarqube.outputs.coverage_percent }}%25-red' alt='Coverage'>" >> $GITHUB_STEP_SUMMARY
          echo "  <img src='https://img.shields.io/badge/Threshold-${{ env.MIN_COVERAGE_THRESHOLD }}%25-blue' alt='Threshold'>" >> $GITHUB_STEP_SUMMARY
          echo "</div>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "<div align='center' style='color:red;font-weight:bold;'>" >> $GITHUB_STEP_SUMMARY
          echo "  Please improve test coverage before merging!" >> $GITHUB_STEP_SUMMARY
          echo "</div>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "<div align='center'>" >> $GITHUB_STEP_SUMMARY
          echo "  <a href='${{ secrets.SONAR_HOST_URL }}/dashboard?id=${{ env.SONAR_PROJECT_KEY }}'>" >> $GITHUB_STEP_SUMMARY
          echo "    <img src='https://img.shields.io/badge/View_Details-SonarQube-red?logo=sonarqube' alt='View Details'>" >> $GITHUB_STEP_SUMMARY
          echo "  </a>" >> $GITHUB_STEP_SUMMARY
          echo "</div>" >> $GITHUB_STEP_SUMMARY

      # Enhanced PR Comment with HTML formatting
      - name: Comment on PR
        if: github.event_name == 'pull_request' && steps.sonarqube.outputs.sonar_exit_code == '0' && steps.sonarqube.outputs.coverage_percent >= env.MIN_COVERAGE_THRESHOLD
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const coverage = parseFloat('${{ steps.sonarqube.outputs.coverage_percent }}').toFixed(2);
            const comment = `
            <div align="center">
              <h2>✅ Code Quality Approved</h2>
              <table>
                <tr>
                  <td><strong>Coverage</strong></td>
                  <td><img src="https://img.shields.io/badge/${coverage}%25-brightgreen" alt="Coverage"></td>
                </tr>
                <tr>
                  <td><strong>Threshold</strong></td>
                  <td><img src="https://img.shields.io/badge/${{ env.MIN_COVERAGE_THRESHOLD }}%25-blue" alt="Threshold"></td>
                </tr>
              </table>
              <p><a href="${{ secrets.SONAR_HOST_URL }}/dashboard?id=${{ env.SONAR_PROJECT_KEY }}">View Full Report</a></p>
            </div>`;
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      # Enhanced Failed PR Comment
      - name: Comment Failed Analysis on PR
        if: github.event_name == 'pull_request' && (steps.sonarqube.outputs.sonar_exit_code != '0' || steps.sonarqube.outputs.coverage_percent < env.MIN_COVERAGE_THRESHOLD)
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const coverage = parseFloat('${{ steps.sonarqube.outputs.coverage_percent }}').toFixed(2);
            const comment = `
            <div align="center">
              <h2>❌ Code Quality Issues Detected</h2>
              <table>
                <tr>
                  <td><strong>Current Coverage</strong></td>
                  <td><img src="https://img.shields.io/badge/${coverage}%25-red" alt="Coverage"></td>
                </tr>
                <tr>
                  <td><strong>Required Threshold</strong></td>
                  <td><img src="https://img.shields.io/badge/${{ env.MIN_COVERAGE_THRESHOLD }}%25-blue" alt="Threshold"></td>
                </tr>
              </table>
              <p style="color:red;font-weight:bold;">Please add more tests to meet coverage requirements</p>
              <p><a href="${{ secrets.SONAR_HOST_URL }}/dashboard?id=${{ env.SONAR_PROJECT_KEY }}">View Details</a></p>
            </div>`;
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      # Enhanced Status Badge Creation
      - name: Create Status Badge
        if: always()
        run: |
          echo "## SonarQube Status" >> $GITHUB_STEP_SUMMARY
          echo "[![SonarQube Status](https://sonarcloud.io/api/project_badges/measure?project=${{ env.SONAR_PROJECT_KEY }}&metric=alert_status)](${{ secrets.SONAR_HOST_URL }}/dashboard?id=${{ env.SONAR_PROJECT_KEY }})" >> $GITHUB_STEP_SUMMARY
          echo "[![Coverage](https://sonarcloud.io/api/project_badges/measure?project=${{ env.SONAR_PROJECT_KEY }}&metric=coverage)](${{ secrets.SONAR_HOST_URL }}/dashboard?id=${{ env.SONAR_PROJECT_KEY }})" >> $GITHUB_STEP_SUMMARY
