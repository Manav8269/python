name: SonarQube Code Analysis
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

# (Environment variables remain unchanged)
env:
  SONAR_PROJECT_KEY: ${{ github.repository_owner }}_${{ github.event.repository.name }}
  SONAR_PROJECT_NAME: ${{ github.repository }}
  WORKSPACE: ${{ github.workspace }}
  LANG: C.UTF-8
  LC_ALL: C.UTF-8
  PYTHONUTF8: 1
  NODE_VERSION: '18'
  SONAR_SCANNER_VERSION: "5.0.1.3006"
  MIN_COVERAGE_THRESHOLD: 80
  COMPLETION_URL: "https://manav8269.github.io/python/"

jobs:
  analyze:
    name: SonarQube Analysis
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
      checks: write
      pull-requests: write
      issues: write
    steps:
      # (All previous steps remain unchanged until conditions are compared)

      # Updated comparison logic
      - name: Create Success Summary
        if: ${{ steps.sonarqube.outputs.sonar_exit_code == '0' && fromJson(steps.sonarqube.outputs.coverage_percent) >= fromJson(env.MIN_COVERAGE_THRESHOLD) }}
        run: |
          echo "## âœ… Code Approved: Coverage ${{ steps.sonarqube.outputs.coverage_percent }}% meets threshold!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Repository:** ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Coverage:** ${{ steps.sonarqube.outputs.coverage_percent }}% (Threshold: ${{ env.MIN_COVERAGE_THRESHOLD }}%)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— [View Full SonarQube Report](${{ secrets.SONAR_HOST_URL }}/dashboard?id=${{ env.SONAR_PROJECT_KEY }})" >> $GITHUB_STEP_SUMMARY

      - name: Create Failure Summary
        if: ${{ steps.sonarqube.outputs.sonar_exit_code != '0' || fromJson(steps.sonarqube.outputs.coverage_percent) < fromJson(env.MIN_COVERAGE_THRESHOLD) }}
        run: |
          echo "## âš ï¸ Code Coverage Below Threshold: ${{ steps.sonarqube.outputs.coverage_percent }}%" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Repository:** ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Coverage:** ${{ steps.sonarqube.outputs.coverage_percent }}% (Threshold: ${{ env.MIN_COVERAGE_THRESHOLD }}%)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Please improve test coverage before merging!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— [View Analysis Results](${{ env.COMPLETION_URL }})" >> $GITHUB_STEP_SUMMARY

      - name: Show Success Popup
        if: ${{ steps.sonarqube.outputs.sonar_exit_code == '0' && fromJson(steps.sonarqube.outputs.coverage_percent) >= fromJson(env.MIN_COVERAGE_THRESHOLD) }}
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            core.notice(`âœ… Code Coverage: ${parseFloat('${{ steps.sonarqube.outputs.coverage_percent }}').toFixed(2)}% - Passed Threshold!`, {title: 'SonarQube Check Success'})

      - name: Show Failure Popup
        if: ${{ steps.sonarqube.outputs.sonar_exit_code != '0' || fromJson(steps.sonarqube.outputs.coverage_percent) < fromJson(env.MIN_COVERAGE_THRESHOLD) }}
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            core.error(`âš ï¸ Code Coverage: ${parseFloat('${{ steps.sonarqube.outputs.coverage_percent }}').toFixed(2)}% - Below Threshold of ${{ env.MIN_COVERAGE_THRESHOLD }}%`, {title: 'SonarQube Check Failed'})

      # You should also update all similar conditional steps (e.g., PR comments, issue creation)
      # using `fromJson(...)` for numeric comparisons

      # Add Result Link to Summary (unchanged)
      - name: Add Result Link to Summary
        if: always()
        run: |
          echo "## ðŸ”— Analysis Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "View detailed results at: [${{ env.COMPLETION_URL }}](${{ env.COMPLETION_URL }})" >> $GITHUB_STEP_SUMMARY
